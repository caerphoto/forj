
var FORJ;if(!FORJ){FORJ={};}
FORJ.ui={panes:undefined,buttons:$("input:submit"),$header:$("#header"),$footer:$("#footer"),$folderList:$("#folder_list"),$foldersLoadingMsg:$("#folders_loading_msg"),btnNewFolder:$("#btnNewFolder"),btnNewThread:$("#btnNewThread"),btnReloadThreadsList:$("#btnReloadThreadsList"),selThreadsView:$("#selThreadsView"),$postsPane:$("#postspane"),$threadLoading:$("#thread_loading"),$threadTitle:$("#thread_title"),$postsContainer:$("#posts_container"),$postButtonsPrev:$("#post_buttons_prev"),$postButtonsNext:$("#post_buttons_next"),btnFirstPosts:$("#btnFirstPosts"),btnPrevPosts:$("#btnPrevPosts"),btnNextPosts:$("#btnNextPosts"),btnLastPosts:$("#btnLastPosts"),$postFragment:$("#post_template"),$replybox:$("#replybox"),$replyboxThreadTitle:$("#replybox_thread_title"),$replyText:$("#replybox texarea").first(),$postPreview:undefined,btnPostReply:$("#btnPostReply"),btnCancelReply:$("#btnCancelReply"),selReplyTo:$("#selReplyTo"),selThreadFolder:$("#selThreadFolder"),showdown:(function(){if(Attacklab){return new Attacklab.showdown.converter();}else{return{makeHtml:function(text){return text;}};}})(),showReplyBox:function(in_post,options){var show_speed,$element,u="u0",post_data;options=options||{new_thread:false,quote:false};if(in_post){show_speed=100;$element=in_post;FORJ.ui.btnCancelReply.button("enable");post_data=FORJ.getData(in_post);FORJ.setData(FORJ.ui.$replybox,post_data);u=(FORJ.status.editing_post?post_data.reply_user:post_data.user_id);}else{show_speed=0;$element=FORJ.ui.$postButtonsNext;FORJ.ui.btnCancelReply.button(options.new_thread?"enable":"disable");}
FORJ.ui.$replybox.detach().insertAfter($element).show();FORJ.ui.selReplyTo.selectmenu("value",u+"");if(in_post){FORJ.ui.$replybox.find("textarea").focus();if(options.quote){FORJ.ui.$replybox.find("textarea").val(FORJ.makeQuote(post_data.body)).trigger("keyup");}}},hideReplyBox:function(){FORJ.ui.btnPostReply.button("enable");FORJ.setData(FORJ.ui.$replybox);FORJ.ui.showReplyBox();}};FORJ.status={current_thread:0,previous_thread:0,editing_post:undefined,offset_top:0,offset_bottom:0,prev_txt:"",current_user:{id:parseInt(($("#sign input").val()).slice(1),10)||0,rank:+($("#sign input").val()).slice(0,1)||0,unread_counts:[]}};FORJ.config={emotes:{":)":"smile",":(":"sad",":D":"joy",":'(":"cry",":P":"tongue",":$":"shame",":O":"gasp",":|":"unamused",":@":"angry",":/":"unsure",":\\":"unsure",":S":"erm",":C":"grumpy",":&AMP;":"yuck",":'D":"joytear","|(":"fail",":{":"tache","8)":"cool",":99:":"rolleyes",":FAIL:":"fail",";)":"wink"},default_post_data:{user_id:0,reply_user:0,post_index:0,id:0,body:""},show_unread:false,unread_priority:false,limit:50,precache:false,MAX_POST_LENGTH:10000,post_preview_target:".post_body",delete_post_url:"/delete_post/",delete_thread_url:"/delete_thread/",edit_post_url:"/edit_post/",edit_folder_url:"/edit_folder/",edit_user_url:"/edit_user/",delete_folder_url:"/delete_folder/",posts_url:"/posts",users_url:"/users",threads_url:"/msg_threads",new_folder_url:"/folders",reply_url:"/posts?reply_user="};FORJ.folders=[];FORJ.threads=[];FORJ.post_cache={};FORJ.setData=function($obj,data){if(data){$obj.data("post_data",data);}else{$obj.data("post_data",FORJ.config.default_post_data);}};FORJ.getData=function($obj){return $obj.data("post_data")||FORJ.config.default_post_data;};FORJ.makeQuote=function(text){var quoted;if(!text){return"";}
quoted="> "+text.split("\n").join("\n> ")+"\n\n";return quoted.replace(/> (\[.+?\]:)/g,"$1");};FORJ.emotify=function(inp){var codeblock=/(<code(?:[^>]*)>[^<]*)<\/code>/i,codeblocks=[],quotedblock=/\w+="[^"]+"/,quotedblocks=[],emote=/([>\s])(?:[:;|8]'?-?(?:[()DpP$oOsScC\/\\{|@]|&amp;)|(?::(?:99|fail):))/g,i=0,emospan;emospan=function(emo){var simple_emote=emo.replace("-","").toUpperCase().slice(1),emote_class=FORJ.config.emotes[simple_emote];return emote_class?['<span class="emote ',emote_class,'">','<span>',emo,'</span>','</span>'].join(""):emo.slice(1);};for(i=0;codeblock.test(inp);i+=1){inp=inp.replace(codeblock,function(){codeblocks[i]=arguments[1];return["FORJ_CODEBLOCK",i,"</code>"].join("");});}
for(i=0;quotedblock.test(inp);i+=1){inp=inp.replace(quotedblock,function(){quotedblocks[i]=arguments[0];return["FORJ_QUOTEDBLOCK",i].join("");});}
inp=inp.replace(emote,function(m){return arguments[1]+emospan(m);});i=-1;inp=inp.replace(/FORJ_CODEBLOCK\d{1,4}/g,function(){i+=1;return codeblocks[i];});i=-1;inp=inp.replace(/FORJ_QUOTEDBLOCK\d{1,4}/g,function(){i+=1;return quotedblocks[i];});return inp;};FORJ.markup=function(inp){if(typeof inp==="string"){inp=FORJ.ui.showdown.makeHtml(inp||" ");inp=inp.replace(/&#(\d+);/g,function(m,n){return String.fromCharCode(n);});inp=inp.replace(/(<.+?style\s*?=\s*?")(.*?)(position\s*?:\s*?(absolute|relative|fixed);?)(.*?">)/gi,"$1$2$5");inp=FORJ.emotify(inp);return inp.replace(/<(\/)?script/gi,"&lt;$1script");}else{return"";}};FORJ.getThread=function(thread_id){var result;_(FORJ.folders).each(function(folder){_(folder.threads).each(function(thread){if(thread.id===thread_id){result=thread;_.breakLoop();}});if(result){_.breakLoop();}});return result;};FORJ.counts=function(thread){if(thread.unread_count){return[" ",thread.unread_count,"&nbsp;new&nbsp;of&nbsp;",thread.post_count].join("");}else{return[" ",thread.post_count,"&nbsp;post",thread.post_count===1?"":"s"].join("");}};FORJ.updateThreadItem=function(thread_id){$(".thread_list_item").each(function(i,ele){if($(ele).data("id")===thread_id){var thread=FORJ.getThread(thread_id);if(thread.unread_count===0){$(ele).removeClass("has_unread");}
$(ele).find("span").html(FORJ.counts(thread));if(thread_id===FORJ.status.current_thread){$(ele).addClass("current_thread");}
return false;}});};FORJ.getFolderFromId=function(folder_id){var result;_(FORJ.folders).each(function(folder){if(folder.id===folder_id){result=folder;_.breakLoop();}});return result;};FORJ.scrollToPost=function($post){var offset=100,pos=FORJ.ui.$replybox.position().top-
(FORJ.ui.$replybox.parent().position().top||0)-
offset;pos=pos<0?0:pos;};FORJ.resetReplyBox=function(){FORJ.ui.$replyboxThreadTitle.find("input").val("");$("#replybox textarea").val("");FORJ.ui.$replybox.find("textarea").trigger("keyup");};FORJ.getPostFromId=function(id){var result;$(".post").each(function(i,el){if(FORJ.getData($(el)).id===id){result=$(el);return false;}});return result;};FORJ.getCacheIndexFromId=function(id){var result;_(FORJ.post_cache.posts).each(function(el,i){if(el.id==id){result=i;_.breakLoop();}});return result;};FORJ.createPost=function(p){var $post=$(FORJ.ui.$postFragment).clone(),reply_url="";$post.find(".post_shim").attr("id",["#",FORJ.status.current_thread,"/",(p.post_index+1)].join(""));if(p.from){$post.find(".post_head_from").attr("href",[FORJ.config.users_url,p.from.id].join("/")).data("id",p.from.id).text(p.from.name);}else{$post.find(".post_head_from").after(document.createTextNode("(anonymous)"));$post.find(".post_head_from").remove();}
if(p.to_user){$post.find(".post_head_to").attr("href",p.to_user.id?[FORJ.config.users_url,p.to_user.id].join("/"):"").data("id",p.to_user.id).text(p.to_user.name);}else{$post.find(".post_head_to").after(document.createTextNode("(all)"));$post.find(".post_head_to").remove();}
$post.find(".post_head_date").text(p.date);$post.find(".post_head_index").text(p.post_index+1).attr("href",["#",FORJ.status.current_thread,"/",(p.post_index+1)].join(""));$post.find(".post_head_reply_index").text(p.to_index+1).attr("href",["#",FORJ.status.current_thread,"/",(p.to_index+1)].join(""));$post.find(".post_body").html(FORJ.markup(p.body));$post.find(".post_sig").html(FORJ.markup(p.from.sig));reply_url=FORJ.config.reply_url+p.post_index;$post.find(".post_foot_reply").attr("href",reply_url);$post.find(".post_foot_quote").attr("href",reply_url+"&quote=true");$post.find(".post_foot_delete").attr("href",FORJ.config.delete_post_url+p.id);if(FORJ.status.current_user.id!==p.from.id&&FORJ.status.current_user.rank<1){$post.find(".post_foot_editlinks").remove();}
FORJ.setData($post,{user_id:p.from?p.from.id:0,reply_user:p.to_user?p.to_user.id:0,post_index:p.post_index,id:p.id,body:p.body});return $post;};FORJ.deletePost=function(post_id){var url,_deleted,_deleted_thread;if(FORJ.getData(FORJ.getPostFromId(post_id)).post_index===0){_deleted_thread=function(response){if(response==="WRONG_USER"){alert("Sorry, you're not authorised to delete this thread.");return;}
FORJ.ui.$replybox.detach();FORJ.ui.$postsContainer.empty();FORJ.ui.$threadTitle.text("");$(".thread_list_item").each(function(i,$item){if($(this).data("id")===FORJ.status.current_thread){$(this).fadeTo(200,0.01,function(){$(this).slideUp(100,function(){$(this).remove();});});return false;}});};if(window.prompt(["Deleting the first post of a thread will also ","delete the entire thread.\n\nAre you sure you want to do this?","\n\nType 'delete' into the box below to confirm:"].join("")).toLowerCase()==="delete"){url=FORJ.config.delete_thread_url+FORJ.status.current_thread;$.get(url,_deleted_thread);}}else{_deleted=function(next_post_id){if(next_post_id==="WRONG_USER"){alert("Sorry, you're not authorised to delete this post.");return;}else{FORJ.getPostFromId(post_id).fadeTo(200,0.01,function(){$(this).slideUp(100,function(){$(this).remove();if(next_post_id!==-1){}});});}};if(window.confirm("Are you sure you want to delete this post?\n\n"+"Post number: "+
(FORJ.getData(FORJ.getPostFromId(post_id)).post_index+1))){url=FORJ.config.delete_post_url+post_id;$.get(url,_deleted);}}};FORJ.getFirstPostOffset=function(thread){var o=thread.post_count-thread.unread_count;if(o>=thread.post_count){o=0;}
return o;};FORJ.showThread=function(t){var thread,s;FORJ.ui.$replyboxThreadTitle.hide();if(typeof t==="string"){t=(window.location.hash).split("/")[0].slice(1);}
t=+t;thread=FORJ.getThread(t);if(thread){FORJ.ui.$threadTitle.show().text(thread.title);FORJ.status.offset_top=FORJ.getFirstPostOffset(thread);}else{s=(window.location.hash).split("/")[1];FORJ.status.offset_top=s-1;thread={id:t};}
FORJ.posts=[];FORJ.ui.$threadLoading.fadeIn(100);FORJ.ui.$replybox.detach();FORJ.showPosts(thread.id,FORJ.status.offset_top,0);};FORJ.showPosts=function(thread_id,offset,insert_direction){var _fetched,url,lim,off;_fetched=function(data){var post_data=data[0],thread=FORJ.getThread(thread_id)||data[1],post_a,has_read,u,ot,time_start,time_end,container;if(Math.abs(insert_direction)===2||insert_direction===0){FORJ.ui.$postsContainer.empty();}
FORJ.ui.$threadTitle.show().text(thread.title);container=document.createDocumentFragment();_(post_data.posts).each(function(p){container.appendChild(FORJ.createPost(p)[0]);});if(insert_direction<0){FORJ.ui.$postsContainer.prepend(container);}else{FORJ.ui.$postsContainer.append(container);}
switch(insert_direction){case-1:post_a=FORJ.post_cache.posts;FORJ.post_cache=post_data;FORJ.post_cache.posts=FORJ.post_cache.posts.concat(post_a);break;case 1:post_a=FORJ.post_cache.posts;FORJ.post_cache=post_data;FORJ.post_cache.posts=post_a.concat(post_data.posts);break;default:FORJ.post_cache=post_data;}
has_read=thread.post_count-thread.unread_count;u=thread.unread_count;u-=FORJ.config.limit;if(u<0){u=0;}
thread.unread_count=u;FORJ.updateThreadItem(thread.id);switch(insert_direction){case-2:FORJ.status.offset_top=0-FORJ.config.limit;FORJ.status.offset_bottom=FORJ.config.limit;break;case-1:FORJ.status.offset_top=offset-FORJ.config.limit;break;case 0:FORJ.status.offset_top=offset-FORJ.config.limit;FORJ.status.offset_bottom=offset+FORJ.config.limit;break;case 1:FORJ.status.offset_bottom=offset+FORJ.config.limit;break;case 2:FORJ.status.offset_top=thread.post_count-FORJ.config.limit*2;FORJ.status.offset_bottom=thread.post_count;break;}
if(FORJ.status.offset_top>0-FORJ.config.limit){FORJ.ui.$postButtonsPrev.show();}else{FORJ.ui.$postButtonsPrev.hide();}
if(thread.post_count>FORJ.status.offset_bottom){FORJ.ui.$postButtonsNext.show();}else{FORJ.ui.$postButtonsNext.hide();}
FORJ.ui.$threadLoading.fadeOut(100);FORJ.ui.showReplyBox();document.title=thread.title+" - FORJ Forum";ot=FORJ.status.offset_top+FORJ.config.limit;if(ot<0){ot=0;}
window.location.hash=["#",FORJ.status.current_thread,"/",ot+1].join("");if(FORJ.folders){FORJ.updateThreadItem(thread_id);}};if(thread_id===FORJ.status.current_thread&&!insert_direction){_fetched(FORJ.post_cache);}else{FORJ.status.current_thread=thread_id;url=FORJ.config.posts_url+"?thread=";lim=offset<0?FORJ.config.limit+offset:FORJ.config.limit;off=offset<0?0:offset;url+=[thread_id,"&offset=",off,"&limit=",lim].join("");$.getJSON(url,_fetched);}};FORJ.populateUserLists=function(users){_(users).each(function(user){FORJ.ui.selReplyTo.append($("<option/>").val(user.id).text(user.name));});FORJ.ui.selReplyTo.selectmenu({style:"dropdown",width:"10em"});};FORJ.populateThreadsList=function(folders){var $folder,total_unread=0;FORJ.threads=[];FORJ.ui.$folderList.empty();FORJ.ui.selThreadFolder.selectmenu("destroy");FORJ.ui.selThreadFolder.empty();total_unread=0;_(folders).each(function(folder){_(folder.threads).each(function(thread){total_unread+=thread.unread_count;});});if(total_unread===0){FORJ.config.show_unread=true;}
_(folders).each(function(folder){var new_folder=$("<li />").data("id",folder.id).addClass("$folderList_item").append($("<a />").addClass("folder_name").text(folder.name).append($("<span />").addClass("item_count").text(" "+folder.thread_count+
(folder.thread_count===1?" thread":" threads"))).append((function(){return FORJ.status.current_user.rank>1&&folder.id>0?$("<a />").addClass("folder_settings"):undefined;})())).appendTo(FORJ.ui.$folderList),$thread_list;FORJ.ui.selThreadFolder.append($("<option />").text(folder.name).val(folder.id));$thread_list=$("<ul />").addClass("thread_list").appendTo(new_folder);_(folder.threads).each(function(thread){if(thread.unread_count||FORJ.config.show_unread||thread.id===FORJ.status.current_thread){var new_item=$("<li/>").addClass("thread_list_item bl").addClass(thread.unread_count>0?"has_unread":"").data("id",thread.id).append($("<a/>").attr("href",["#",thread.id,"/",(FORJ.getFirstPostOffset(thread)+1)].join("")).text(thread.title)).append($("<span/>").addClass("item_count").html(FORJ.counts(thread)));if(thread.id===FORJ.status.current_thread){new_item.addClass("current_thread");}
$thread_list.append(new_item);}
FORJ.threads.push(thread);});});FORJ.ui.selThreadFolder.selectmenu({style:"dropdown",width:"20em"});if(FORJ.config.show_unread){FORJ.ui.selThreadsView.selectmenu("value","ALL");}
FORJ.folders=folders;FORJ.ui.$foldersLoadingMsg.fadeOut(100);};FORJ.newPostCallback=function(newpost){FORJ.ui.$replyboxThreadTitle.hide();if(newpost.post_index===0){FORJ.loadThreadsList();FORJ.status.current_thread=newpost.thread;}
FORJ.resetReplyBox();FORJ.ui.hideReplyBox();if(FORJ.status.editing_post){FORJ.createPost(newpost).insertAfter(FORJ.status.editing_post);FORJ.status.editing_post.remove();FORJ.status.editing_post=undefined;}else{FORJ.createPost(newpost).appendTo(FORJ.ui.$postsContainer);}};FORJ.lnkReplyClick=function(event){event.preventDefault();FORJ.ui.showReplyBox($(this).parents(".post"));};FORJ.lnkReplyQuoteClick=function(event){event.preventDefault();FORJ.ui.showReplyBox($(this).parents(".post"),{quote:true});};FORJ.lnkEditClick=function(event){event.preventDefault();var post=$(this).parents(".post");FORJ.status.editing_post=post;FORJ.ui.$replybox.find("textarea").val(FORJ.getData(post).body);FORJ.ui.showReplyBox(post);FORJ.ui.$replybox.find("textarea").trigger("keyup");post.hide();};FORJ.lnkDeleteClick=function(event){event.preventDefault();FORJ.deletePost(FORJ.getData($(this).parents(".post")).id);};FORJ.btnFirstPostsClick=function(){FORJ.ui.$threadLoading.fadeIn(100);FORJ.showPosts(FORJ.status.current_thread,0,-2);};FORJ.btnPrevPostsClick=function(){FORJ.ui.$threadLoading.fadeIn(100);FORJ.showPosts(FORJ.status.current_thread,FORJ.status.offset_top,-1);};FORJ.btnNextPostsClick=function(){FORJ.ui.$threadLoading.fadeIn(100);FORJ.showPosts(FORJ.status.current_thread,FORJ.status.offset_bottom,1);};FORJ.btnLastPostsClick=function(){FORJ.ui.$threadLoading.fadeIn(100);var t=FORJ.getThread(FORJ.status.current_thread);FORJ.showPosts(FORJ.status.current_thread,t.post_count-FORJ.config.limit,2);};FORJ.postTextChange=function(is_sig){var txt=$(this).val()||" ",length_thingy;if(txt===FORJ.status.prev_txt){return;}else{FORJ.status.prev_txt=txt;}
length_thingy=$("#post_length");length_thingy.text(txt.length);if(txt.length>FORJ.config.MAX_POST_LENGTH){length_thingy.addClass("field_with_errors");}else{length_thingy.removeClass("field_with_errors");}
window.setTimeout(function(){var h=FORJ.markup(txt);FORJ.ui.$postPreview.find(FORJ.config.post_preview_target).html(h);},0);};FORJ.btnPostReplyClick=function(){var url="",title,post_data,d,txt;FORJ.ui.btnPostReply.button("disable");if(FORJ.status.current_thread===0){title=FORJ.ui.$replyboxThreadTitle.find("input").val();url=FORJ.config.threads_url;url+=["?title=",encodeURIComponent(title),"&folder=",FORJ.ui.selThreadFolder.val()].join("");}else{post_data=FORJ.getData(FORJ.ui.$replybox);if(FORJ.status.editing_post){url=FORJ.config.edit_post_url+post_data.id;d=FORJ.ui.selReplyTo.val();url+=["?","reply_user=",d].join("");}else{url=FORJ.config.reply_url;url+=[FORJ.ui.selReplyTo.val(),"&thread=",FORJ.status.current_thread,"&reply_index=",post_data.post_index||0].join("");}}
txt=(FORJ.ui.$replybox.find("textarea").val()).slice(0,FORJ.config.MAX_POST_LENGTH);$.post(url,{textData:txt},FORJ.newPostCallback);};FORJ.lnkUserClick=function(event){var user_id;event.preventDefault();user_id=$(this).data("id");FORJ.user_editor.open(user_id);};FORJ.btnCancelReplyClick=function(){FORJ.ui.$replyboxThreadTitle.hide();if(FORJ.status.previous_thread){FORJ.status.current_thread=FORJ.status.previous_thread;FORJ.status.previous_thread=0;FORJ.showThread(FORJ.status.current_thread);}else{if(FORJ.status.editing_post){FORJ.status.editing_post.show();FORJ.status.editing_post=undefined;}
FORJ.resetReplyBox();FORJ.ui.hideReplyBox();}};FORJ.lnkThreadClick=function(event){event.preventDefault();$(".current_thread").removeClass("current_thread");$(this).addClass("current_thread");FORJ.status.current_thread=0;FORJ.showThread($(this).data("id"));};FORJ.lnkFolderClick=function(){if(!FORJ.status.editing_folder){$(this).toggleClass("folder_contracted").next().slideToggle(200);}
FORJ.status.editing_folder=false;};FORJ.lnkFolderSettingsClick=function(event){var id=$(this).parents("li").data("id");FORJ.status.editing_folder=true;FORJ.dlgFolderEditor.open(id);};FORJ.btnNewThreadClick=function(){FORJ.status.previous_thread=FORJ.status.current_thread;FORJ.status.current_thread=0;FORJ.ui.$threadTitle.hide();FORJ.ui.showReplyBox(undefined,{new_thread:true});FORJ.ui.$postsContainer.empty();FORJ.ui.$replyboxThreadTitle.show();FORJ.ui.$replyboxThreadTitle.find("input").focus();};FORJ.btnNewFolderClick=function(){var folder_name=prompt("What would you like to call the new folder?"),_newFolder,url;if(folder_name){_newFolder=function(folders){FORJ.populateThreadsList(folders);};url=[FORJ.config.new_folder_url,"?name=",encodeURIComponent(folder_name)].join("");$.post(url,_newFolder);}};FORJ.selThreadsViewChange=function(){switch(this.value){case"UNREAD":FORJ.config.show_unread=false;break;case"ALL":FORJ.config.show_unread=true;break;}
FORJ.populateThreadsList(FORJ.folders);};FORJ.loadThreadsList=function(){FORJ.ui.$foldersLoadingMsg.fadeIn(100);$.get(FORJ.config.threads_url,FORJ.populateThreadsList);};FORJ.logoClick=function(){window.location="/";};FORJ.lipsum=function(){return"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla eget tempor lacus. Aenean condimentum sem velit. Nulla fringilla, ligula in fringilla dignissim, erat enim malesuada nibh, sit amet convallis lectus mi quis nibh. Suspendisse congue dolor diam. Phasellus faucibus dignissim ligula ut lacinia. Phasellus mattis luctus elit ut porta. Cras.";};FORJ.createPostPreview=function(sig){FORJ.config.post_preview_target=sig?".post_sig":".post_body";$("#max_post_length").text(FORJ.config.MAX_POST_LENGTH);FORJ.ui.$postPreview=FORJ.ui.$postFragment.clone();FORJ.ui.$postPreview.removeClass("hidden").addClass("post_preview").removeAttr("id");FORJ.ui.$postPreview.find(".post_head").remove();FORJ.ui.$postPreview.find(".post_foot").remove();if(sig){FORJ.ui.$postPreview.find(".post_body").text(FORJ.lipsum()).addClass("sig_body_preview");}else{FORJ.ui.$postPreview.find(".post_sig").remove();}};FORJ.initUserEditor=function(){FORJ.user_editor=(function(){var dlg=$("#dlgUserEditor"),user,UE_name,UE_email,UE_rank,UE_loading,UE_last_login,ranks;if(!dlg){return;}
user={id:0,name:"",email:"",rank:-1,last_login:""};UE_name=$("#UE_name");UE_email=$("#UE_email");UE_rank=$("#UE_rank");UE_loading=$("#UE_loading");UE_last_login=$("#UE_last_login");ranks=["Anonymous","Normal user","Moderator","Admin"];dlg.removeClass("unfouc").dialog({autoOpen:false,modal:true,width:"25em",title:"User Details"});dlg.dialog("option","buttons",[{enabled:FORJ.status.current_user.rank>1,text:"OK",click:function(){var newrank=-1,_editUserCallback,url;dlg.find("input[name='user_type']").each(function(){if($(this).attr("checked")){newrank=+($(this).val());return false;}});if(newrank===-1){$(this).dialog("close");}else{_editUserCallback=function(res){dlg.dialog("close");};url=FORJ.config.edit_user_url+user.id;url+=["?","newrank=",newrank].join("");if(FORJ.status.current_user.rank>1){$.post(url,_editUserCallback);}}}},{text:"Cancel",click:function(){$(this).dialog("close");}}]);FORJ.ui.$postsContainer.delegate(".post_head_fromto a","click",FORJ.lnkUserClick);return{open:function(user_id){UE_loading.show().fadeTo(0,1);UE_name.text("");UE_email.text("");UE_rank.text("");UE_last_login.text("");dlg.find("input[type=radio]").removeAttr("checked");var url=[FORJ.config.users_url,user_id].join("/"),_userFetched=function(user_info){UE_loading.fadeTo(200,0.01,function(){UE_loading.slideUp(50);});user=user_info;UE_name.text(user.name);UE_email.text(user.email);UE_rank.text(ranks[user.rank]||"Forum owner");dlg.find("input[name='user_type']").each(function(){if($(this).val()==user.rank){$(this).attr("checked","checked");return false;}});UE_last_login.text(user.last_login);};dlg.dialog("open");$.get(url,_userFetched);}};})();};FORJ.initFolderEditor=function(){FORJ.dlgFolderEditor=(function(){var _dlg=$("#dlgFolderEditor"),folder,tbxName;if(!_dlg){return;}
tbxName=$("#tbxFE_Name");_dlg.removeClass("unfouc").dialog({autoOpen:false,modal:true,width:"30em",buttons:{"Delete":function(){if(window.confirm(["Are you sure you want to delete this folder:",folder.name,"Any threads it contains will be moved to the "+"'Uncategorised' folder."].join("\n\n"))){var url=FORJ.config.delete_folder_url+folder.id,self=this;$.post(url,function(newfolders){FORJ.populateThreadsList(newfolders);$(self).dialog("close");});}},"OK":function(){var url=FORJ.config.edit_folder_url+folder.id+"?",self=this,clearance=-1;$(self).find("input[name='clearance']").each(function(){if($(this).attr("checked")){clearance=+($(this).val());return false;}});if(clearance===-1){$(self).dialog("close");}else{url+=["clearance=",clearance,"&newname=",encodeURIComponent(tbxName.val())].join("");$.post(url,function(newdata){_(FORJ.folders).each(function(f){if(f.id===folder.id){f.name=newdata.name;f.clearance=newdata.clearance;FORJ.populateThreadsList(FORJ.folders);_.breakLoop();}});$(self).dialog("close");});}},"Cancel":function(){$(this).dialog("close");}}});return{open:function(folder_id){folder=FORJ.getFolderFromId(folder_id);tbxName.val(folder.name);_dlg.find("input[type=radio]").removeAttr("checked");_dlg.find("input[name='clearance']").each(function(){if($(this).val()==folder.clearance){$(this).attr("checked","checked");return false;}});_dlg.dialog("option","title","Edit Folder: "+folder.name);_dlg.dialog("open");tbxName.focus();}};})();};FORJ.initForum=function(config){if(config&&typeof(config)=="object"){$.extend(FORJ.config,config);}
$.ajaxSetup({cache:false});FORJ.ui.$postsContainer.delegate(".post_foot_reply","click",FORJ.lnkReplyClick).delegate(".post_foot_replyquote","click",FORJ.lnkReplyQuoteClick).delegate(".post_foot_delete","click",FORJ.lnkDeleteClick).delegate(".post_foot_edit","click",FORJ.lnkEditClick);FORJ.ui.$postsPane.delegate("#replybox textarea","keyup",FORJ.postTextChange);FORJ.ui.$folderList.delegate(".thread_list_item","click",FORJ.lnkThreadClick).delegate(".folder_name","click",FORJ.lnkFolderClick).delegate(".folder_settings","click",FORJ.lnkFolderSettingsClick);FORJ.ui.btnPostReply.button().click(FORJ.btnPostReplyClick);FORJ.ui.btnCancelReply.button().click(FORJ.btnCancelReplyClick);FORJ.ui.btnNewThread.button().click(FORJ.btnNewThreadClick);FORJ.ui.btnNewFolder.button().click(FORJ.btnNewFolderClick);FORJ.ui.btnReloadThreadsList.button({icons:{primary:"btn-icon-reload"}}).click(FORJ.loadThreadsList);FORJ.ui.selThreadsView.change(FORJ.selThreadsViewChange).val("UNREAD").selectmenu({style:"dropdown",width:"14em"});FORJ.ui.btnFirstPosts.button({icons:{primary:"btn-icon-firstposts"}}).click(FORJ.btnFirstPostsClick);FORJ.ui.btnPrevPosts.button({icons:{primary:"btn-icon-prevposts"}}).click(FORJ.btnPrevPostsClick);FORJ.ui.btnNextPosts.button({icons:{primary:"btn-icon-nextposts"}}).click(FORJ.btnNextPostsClick);FORJ.ui.btnLastPosts.button({icons:{primary:"btn-icon-lastposts"}}).click(FORJ.btnLastPostsClick);$(".posts_nav").hide();FORJ.initUserEditor();FORJ.initFolderEditor();$(".post").removeClass("unfouc");FORJ.createPostPreview();FORJ.ui.$postPreview.insertAfter(FORJ.ui.$replybox.find("#post_preview_info"));FORJ.ui.$replyboxThreadTitle.hide();FORJ.ui.$replybox.removeClass("unfouc");FORJ.ui.$replybox.hide();$.get(FORJ.config.users_url,FORJ.populateUserLists);FORJ.loadThreadsList();FORJ.ui.$postFragment.detach().removeAttr("id");FORJ.ui.$postButtonsPrev.removeClass("unfouc");FORJ.ui.$postButtonsNext.removeClass("unfouc");if(window.location.hash){FORJ.showThread(window.location.hash);}};FORJ.initOther=function(){FORJ.ui.buttons.button();FORJ.config.MAX_POST_LENGTH=255;$(".post").removeClass("unfouc");FORJ.createPostPreview(true);FORJ.ui.$postPreview.insertBefore(FORJ.ui.$postFragment);FORJ.ui.$postFragment.remove();$("#sigeditor").delegate("textarea","keyup",FORJ.postTextChange);$("#sigeditor textarea").trigger("keyup");};$(document).ready(function(){if(document.getElementById("threadspane")){FORJ.initForum();}else{FORJ.initOther();}});